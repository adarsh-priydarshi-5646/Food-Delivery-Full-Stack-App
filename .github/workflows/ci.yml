name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # FRONTEND - Complete CI
  # ============================================
  
  frontend-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install and verify dependencies
        working-directory: frontend
        run: |
          npm ci
          echo "✅ Dependencies installed successfully"

  frontend-lint:
    needs: frontend-dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run ESLint
        working-directory: frontend
        run: npm run lint

  frontend-test:
    needs: frontend-dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run tests
        working-directory: frontend
        run: npm test

  frontend-build:
    needs: [frontend-lint, frontend-test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build
        working-directory: frontend
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_STRIPE_PUBLIC_KEY: ${{ secrets.VITE_STRIPE_PUBLIC_KEY }}

      - name: Verify build
        working-directory: frontend
        run: |
          if [ ! -d "dist" ] || [ ! -f "dist/index.html" ]; then
            echo "❌ Build failed!"
            exit 1
          fi
          echo "✅ Build successful"
          ls -la dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 7

  frontend-security:
    needs: frontend-dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run security audit
        working-directory: frontend
        run: npm audit --audit-level=critical

  # ============================================
  # BACKEND - Complete CI
  # ============================================
  
  backend-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install and verify dependencies
        working-directory: backend
        run: |
          npm ci
          echo "✅ Dependencies installed successfully"

  backend-lint:
    needs: backend-dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Check main entry point
        working-directory: backend
        run: node --check index.js

      - name: Check all JavaScript files
        working-directory: backend
        run: |
          echo "Checking all JS files..."
          find . -name "*.js" -not -path "./node_modules/*" | while read file; do
            node --check "$file" || exit 1
            echo "✓ $file"
          done
          echo "✅ All files have valid syntax"

  backend-security:
    needs: backend-dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Run security audit
        working-directory: backend
        run: npm audit --audit-level=critical

  # ============================================
  # CODE QUALITY
  # ============================================
  
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for merge conflicts
        run: |
          if grep -rn "<<<<<<< \|>>>>>>> \|=======" --include="*.js" --include="*.jsx" --include="*.json" --include="*.css" --include="*.md" . 2>/dev/null | grep -v node_modules; then
            echo "❌ Merge conflict markers found!"
            exit 1
          fi
          echo "✅ No merge conflicts"

      - name: Check for debug statements
        run: |
          DEBUG_COUNT=$(grep -rn "debugger" frontend/src backend --include="*.js" --include="*.jsx" 2>/dev/null | grep -v node_modules | wc -l || echo "0")
          if [ "$DEBUG_COUNT" -gt 0 ]; then
            echo "❌ Found debugger statements!"
            grep -rn "debugger" frontend/src backend --include="*.js" --include="*.jsx" 2>/dev/null | grep -v node_modules
            exit 1
          fi
          echo "✅ No debugger statements"

  # ============================================
  # FINAL STATUS - Must pass for merge
  # ============================================
  
  ci-status:
    needs: [
      frontend-dependencies,
      frontend-lint,
      frontend-test,
      frontend-build,
      frontend-security,
      backend-dependencies,
      backend-lint,
      backend-security,
      code-quality
    ]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: CI Status Check
        run: |
          echo "========== CI PIPELINE RESULTS =========="
          echo "Frontend Dependencies: ${{ needs.frontend-dependencies.result }}"
          echo "Frontend Lint: ${{ needs.frontend-lint.result }}"
          echo "Frontend Test: ${{ needs.frontend-test.result }}"
          echo "Frontend Build: ${{ needs.frontend-build.result }}"
          echo "Frontend Security: ${{ needs.frontend-security.result }}"
          echo "Backend Dependencies: ${{ needs.backend-dependencies.result }}"
          echo "Backend Lint: ${{ needs.backend-lint.result }}"
          echo "Backend Security: ${{ needs.backend-security.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "=========================================="
          
          FAILED=false
          
          for job in frontend-dependencies frontend-lint frontend-test frontend-build backend-dependencies backend-lint code-quality; do
            result="${{ needs.frontend-dependencies.result }}"
            case $job in
              frontend-dependencies) result="${{ needs.frontend-dependencies.result }}" ;;
              frontend-lint) result="${{ needs.frontend-lint.result }}" ;;
              frontend-test) result="${{ needs.frontend-test.result }}" ;;
              frontend-build) result="${{ needs.frontend-build.result }}" ;;
              backend-dependencies) result="${{ needs.backend-dependencies.result }}" ;;
              backend-lint) result="${{ needs.backend-lint.result }}" ;;
              code-quality) result="${{ needs.code-quality.result }}" ;;
            esac
            
            if [ "$result" != "success" ]; then
              echo "❌ $job failed with result: $result"
              FAILED=true
            fi
          done
          
          if [ "$FAILED" = true ]; then
            echo ""
            echo "❌ CI PIPELINE FAILED"
            exit 1
          fi
          
          echo ""
          echo "✅ CI PIPELINE PASSED - All checks successful!"
